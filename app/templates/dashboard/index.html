{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Upload CSV{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h2 mb-4">
            <i class="bi bi-speedometer2"></i> Dashboard
        </h1>
    </div>
</div>

<!-- Cards de Estatísticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_uploads }}</h4>
                        <p class="card-text">Total de Uploads</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-cloud-upload fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_rows or 0 }}</h4>
                        <p class="card-text">Total de Linhas</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-list-ul fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">
                            {% if stats.last_upload %}
                                {{ stats.last_upload.uploaded_at.strftime('%d/%m/%Y') }}
                            {% else %}
                                -
                            {% endif %}
                        </h4>
                        <p class="card-text">Último Upload</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-calendar-event fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">
                            {% if stats.last_upload %}
                                {{ stats.last_upload.original_name[:20] }}{% if stats.last_upload.original_name|length > 20 %}...{% endif %}
                            {% else %}
                                Nenhum
                            {% endif %}
                        </h4>
                        <p class="card-text">Último Arquivo</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-file-earmark-spreadsheet fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seção de Gráficos Militares -->
{% if military_stats %}
<div class="row mb-4">
    <div class="col-12">
        <h3 class="h4 mb-3">
            <i class="bi bi-shield-check"></i> Análise de Dados Militares
        </h3>
    </div>
</div>

<div class="row mb-4">
    <!-- Distribuição por UF de Nascimento -->
    {% if military_stats.uf_nascimento %}
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-geo-alt"></i> Distribuição por UF de Nascimento
                </h5>
            </div>
            <div class="card-body">
                <canvas id="ufNascimentoChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Distribuição por Sexo -->
    {% if military_stats.sexo %}
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-person-check"></i> Distribuição por Sexo
                </h5>
            </div>
            <div class="card-body">
                <canvas id="sexoChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="row mb-4">
    <!-- Distribuição por Estado Civil -->
    {% if military_stats.estado_civil %}
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-heart"></i> Distribuição por Estado Civil
                </h5>
            </div>
            <div class="card-body">
                <canvas id="estadoCivilChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Distribuição por Dispensa -->
    {% if military_stats.dispensa %}
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-check-circle"></i> Status de Dispensa
                </h5>
            </div>
            <div class="card-body">
                <canvas id="dispensaChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="row mb-4">
    <!-- Distribuição por Zona Residencial -->
    {% if military_stats.zona_residencial %}
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-house"></i> Zona Residencial
                </h5>
            </div>
            <div class="card-body">
                <canvas id="zonaResidencialChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Distribuição por Escolaridade -->
    {% if military_stats.escolaridade %}
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-mortarboard"></i> Nível de Escolaridade
                </h5>
            </div>
            <div class="card-body">
                <canvas id="escolaridadeChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="row mb-4">
    <!-- Distribuição por Ano de Nascimento -->
    {% if military_stats.ano_nascimento %}
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-range"></i> Distribuição por Década de Nascimento
                </h5>
            </div>
            <div class="card-body">
                <canvas id="anoNascimentoChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Estatísticas Físicas -->
    {% if military_stats.estatisticas_fisicas %}
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-rulers"></i> Estatísticas Físicas
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for medida, dados in military_stats.estatisticas_fisicas.items() %}
                    <div class="col-12 mb-3">
                        <h6 class="text-capitalize">{{ medida }}</h6>
                        <div class="small">
                            <div>Média: {{ "%.1f"|format(dados.media) }}</div>
                            <div>Mediana: {{ "%.1f"|format(dados.mediana) }}</div>
                            <div>Min: {{ "%.1f"|format(dados.min) }}</div>
                            <div>Max: {{ "%.1f"|format(dados.max) }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="row">
    <!-- Gráfico de Distribuição de Tipos -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart"></i> Distribuição por Tipo de Dados
                </h5>
            </div>
            <div class="card-body">
                <canvas id="dtypeChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Formulário de Upload -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-cloud-upload"></i> Upload de CSV
                </h5>
            </div>
            <div class="card-body">
                <form method="post" action="/upload-csv" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    
                    <div class="mb-3">
                        <label for="file" class="form-label">Selecionar Arquivo CSV</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                        <div class="form-text">
                            Apenas arquivos .csv são permitidos. Máximo: 500MB
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-upload"></i> Enviar Arquivo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Informações do Último Upload -->
{% if stats.last_upload %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> Detalhes do Último Upload
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Arquivo:</strong><br>
                        {{ stats.last_upload.original_name }}
                    </div>
                    <div class="col-md-3">
                        <strong>Data:</strong><br>
                        {{ stats.last_upload.uploaded_at.strftime('%d/%m/%Y %H:%M') }}
                    </div>
                    <div class="col-md-3">
                        <strong>Linhas:</strong><br>
                        {{ stats.last_upload.rows_total or 'N/A' }}
                    </div>
                    <div class="col-md-3">
                        <strong>Colunas:</strong><br>
                        {{ stats.last_upload.cols_total or 'N/A' }}
                    </div>
                </div>
                <div class="mt-3">
                    <a href="/database/{{ stats.last_upload.id }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-eye"></i> Ver Detalhes
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Cores padrão para os gráficos
const chartColors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
];

// Gráfico de distribuição de tipos
const ctx = document.getElementById('dtypeChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: {{ chart_data.labels | tojson }},
        datasets: [{
            data: {{ chart_data.data | tojson }},
            backgroundColor: chartColors,
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

{% if military_stats %}
// Gráfico de UF de Nascimento
{% if military_stats.uf_nascimento %}
const ufNascimentoCtx = document.getElementById('ufNascimentoChart').getContext('2d');
new Chart(ufNascimentoCtx, {
    type: 'bar',
    data: {
        labels: {{ military_stats.uf_nascimento.labels | tojson }},
        datasets: [{
            label: 'Quantidade',
            data: {{ military_stats.uf_nascimento.data | tojson }},
            backgroundColor: '#36A2EB',
            borderColor: '#36A2EB',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
{% endif %}

// Gráfico de Sexo
{% if military_stats.sexo %}
const sexoCtx = document.getElementById('sexoChart').getContext('2d');
new Chart(sexoCtx, {
    type: 'pie',
    data: {
        labels: {{ military_stats.sexo.labels | tojson }},
        datasets: [{
            data: {{ military_stats.sexo.data | tojson }},
            backgroundColor: ['#FF6384', '#36A2EB'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}

// Gráfico de Estado Civil
{% if military_stats.estado_civil %}
const estadoCivilCtx = document.getElementById('estadoCivilChart').getContext('2d');
new Chart(estadoCivilCtx, {
    type: 'doughnut',
    data: {
        labels: {{ military_stats.estado_civil.labels | tojson }},
        datasets: [{
            data: {{ military_stats.estado_civil.data | tojson }},
            backgroundColor: chartColors,
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}

// Gráfico de Dispensa
{% if military_stats.dispensa %}
const dispensaCtx = document.getElementById('dispensaChart').getContext('2d');
new Chart(dispensaCtx, {
    type: 'pie',
    data: {
        labels: {{ military_stats.dispensa.labels | tojson }},
        datasets: [{
            data: {{ military_stats.dispensa.data | tojson }},
            backgroundColor: ['#28a745', '#dc3545'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}

// Gráfico de Zona Residencial
{% if military_stats.zona_residencial %}
const zonaResidencialCtx = document.getElementById('zonaResidencialChart').getContext('2d');
new Chart(zonaResidencialCtx, {
    type: 'doughnut',
    data: {
        labels: {{ military_stats.zona_residencial.labels | tojson }},
        datasets: [{
            data: {{ military_stats.zona_residencial.data | tojson }},
            backgroundColor: ['#4BC0C0', '#FFCE56'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}

// Gráfico de Escolaridade
{% if military_stats.escolaridade %}
const escolaridadeCtx = document.getElementById('escolaridadeChart').getContext('2d');
new Chart(escolaridadeCtx, {
    type: 'bar',
    data: {
        labels: {{ military_stats.escolaridade.labels | tojson }},
        datasets: [{
            label: 'Quantidade',
            data: {{ military_stats.escolaridade.data | tojson }},
            backgroundColor: '#9966FF',
            borderColor: '#9966FF',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
{% endif %}

// Gráfico de Ano de Nascimento
{% if military_stats.ano_nascimento %}
const anoNascimentoCtx = document.getElementById('anoNascimentoChart').getContext('2d');
new Chart(anoNascimentoCtx, {
    type: 'line',
    data: {
        labels: {{ military_stats.ano_nascimento.labels | tojson }},
        datasets: [{
            label: 'Quantidade',
            data: {{ military_stats.ano_nascimento.data | tojson }},
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: '#36A2EB',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
{% endif %}
{% endif %}
</script>
{% endblock %}
