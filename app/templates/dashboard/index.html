{% extends "base.html" %}

{% block title %}Dashboard - Sistema de Upload CSV{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h2 mb-4">
            <i class="bi bi-speedometer2"></i> Dashboard
        </h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="totalUploadsValue">0</h4>
                        <p class="card-text">Total de Uploads</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-cloud-upload fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="totalRowsValue">0</h4>
                        <p class="card-text">Total de Linhas</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-list-ul fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="lastUploadDateValue">-</h4>
                        <p class="card-text">Último Upload</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-calendar-event fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="lastFileNameValue">Nenhum</h4>
                        <p class="card-text">Último Arquivo</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-file-earmark-spreadsheet fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="militaryStatsSection"> 
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="h4 mb-3">
                <i class="bi bi-shield-check"></i> Análise de Dados Militares
            </h3>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-6 mb-4" id="ufNascimentoCard">
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-geo-alt"></i> Distribuição por UF de Nascimento</h5></div>
                <div class="card-body"><canvas id="ufNascimentoChart" width="400" height="300"></canvas></div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4" id="sexoCard">
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-person-check"></i> Distribuição por Sexo</h5></div>
                <div class="card-body"><canvas id="sexoChart" width="400" height="300"></canvas></div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-lg-4 mb-4" id="physicalStatsCard">
            <div class="card">
                <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-rulers"></i> Estatísticas Físicas</h5></div>
                <div class="card-body">
                    <div class="row" id="physicalStatsBody">
                        <p class="text-center text-muted">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-pie-chart"></i> Distribuição por Tipo de Dados
                </h5>
            </div>
            <div class="card-body"><canvas id="dtypeChart" width="400" height="200"></canvas></div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-cloud-upload"></i> Upload de CSV</h5></div>
            <div class="card-body">
                <form method="post" action="/upload-csv" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="mb-3">
                        <label for="file" class="form-label">Selecionar Arquivo CSV</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                        <div class="form-text">Apenas arquivos .csv são permitidos. Máximo: 500MB</div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary"><i class="bi bi-upload"></i> Enviar Arquivo</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row" id="lastUploadDetailsRow" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-info-circle"></i> Detalhes do Último Upload</h5></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3"><strong>Arquivo:</strong><br><span id="detailFileName"></span></div>
                    <div class="col-md-3"><strong>Data:</strong><br><span id="detailFileDate"></span></div>
                    <div class="col-md-3"><strong>Linhas:</strong><br><span id="detailFileRows"></span></div>
                    <div class="col-md-3"><strong>Colunas:</strong><br><span id="detailFileCols"></span></div>
                </div>
                <div class="mt-3">
                    <a href="#" id="detailFileLink" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-eye"></i> Ver Detalhes
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
<script>
// Cores padrão para os gráficos
const chartColors = [
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
];

/**
 * Função utilitária para criar um gráfico Chart.js
 * @param {string} canvasId O ID do canvas no HTML
 * @param {string} type O tipo de gráfico ('bar', 'pie', 'line', etc.)
 * @param {Array<string>} labels Rótulos do eixo/setores
 * @param {Array<number>} data Valores de dados
 * @param {Array<string>} backgroundColors Cores dos fundos
 * @param {boolean} legendDisplay Define se a legenda deve ser exibida
 * @param {object} customOptions Opções adicionais para o Chart.js
 */
function createChart(canvasId, type, labels, data, backgroundColors, legendDisplay = false, customOptions = {}) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return; // Sai se o canvas não existir

    new Chart(ctx.getContext('2d'), {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                label: 'Quantidade',
                data: data,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(c => c.replace('0.2', '1')), // Para linhas/barras
                borderWidth: 1,
                // Opções específicas para gráficos de linha
                ...(type === 'line' && { fill: true, tension: 0.4, backgroundColor: backgroundColors[0].replace('1', '0.2') })
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            },
            plugins: {
                legend: { position: 'bottom', display: legendDisplay }
            },
            ...customOptions
        }
    });
}

/**
 * Função principal que busca os dados da API e renderiza o dashboard.
 */
async function loadDashboardData() {
    try {
        const response = await fetch('/api/v1/dashboard');
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        const data = await response.json();

        // ---------------------------------------------
        // 1. ATUALIZAR CARDS DE ESTATÍSTICAS GERAIS (stats)
        // ---------------------------------------------
        document.getElementById('totalUploadsValue').innerText = data.stats.total_uploads.toLocaleString('pt-BR');
        document.getElementById('totalRowsValue').innerText = data.stats.total_rows.toLocaleString('pt-BR');

        // Detalhes do Último Upload
        if (data.stats.last_upload) {
            const lastUpload = data.stats.last_upload;
            const uploadDate = new Date(lastUpload.uploaded_at);
            
            // Formatando data para o card
            document.getElementById('lastUploadDateValue').innerText = uploadDate.toLocaleDateString('pt-BR');
            
            // Formatando nome do arquivo para o card (limitando a 20 caracteres)
            const fileName = lastUpload.original_name;
            document.getElementById('lastFileNameValue').innerText = 
                fileName.length > 20 ? fileName.substring(0, 20) + '...' : fileName;

            // Injetando detalhes do upload (na seção inferior)
            document.getElementById('detailFileName').innerText = fileName;
            document.getElementById('detailFileDate').innerText = uploadDate.toLocaleString('pt-BR');
            document.getElementById('detailFileRows').innerText = lastUpload.rows_total ? lastUpload.rows_total.toLocaleString('pt-BR') : 'N/A';
            document.getElementById('detailFileCols').innerText = lastUpload.cols_total ? lastUpload.cols_total.toLocaleString('pt-BR') : 'N/A';
            document.getElementById('detailFileLink').href = `/database/${lastUpload.id}`;
            document.getElementById('lastUploadDetailsRow').style.display = 'flex';

        } else {
            document.getElementById('lastUploadDetailsRow').style.display = 'none';
        }

        // ---------------------------------------------
        // 2. GRÁFICO DE DISTRIBUIÇÃO DE TIPOS (dtypeChart)
        // ---------------------------------------------
        if (data.chart_data && data.chart_data.data.length > 0) {
            const backgroundColors = data.chart_data.labels.map((_, i) => chartColors[i % chartColors.length]);
            createChart('dtypeChart', 'doughnut', data.chart_data.labels, data.chart_data.data, backgroundColors, true, { scales: { y: { display: false } } });
        }


        // ---------------------------------------------
        // 3. GRÁFICOS MILITARES (military_stats)
        // ---------------------------------------------
        const militaryStats = data.military_stats;
        const militaryStatsSection = document.getElementById('militaryStatsSection');

        if (Object.values(militaryStats).some(stat => stat !== null)) {
            militaryStatsSection.style.display = 'block';

            // Gráfico UF de Nascimento (Barra)
            if (militaryStats.uf_nascimento) {
                document.getElementById('ufNascimentoCard').style.display = 'block';
                createChart('ufNascimentoChart', 'bar', militaryStats.uf_nascimento.labels, militaryStats.uf_nascimento.data, ['#36A2EB']);
            } else {
                document.getElementById('ufNascimentoCard').style.display = 'none';
            }

            // Gráfico Sexo (Pizza)
            if (militaryStats.sexo) {
                document.getElementById('sexoCard').style.display = 'block';
                createChart('sexoChart', 'pie', militaryStats.sexo.labels, militaryStats.sexo.data, ['#FF6384', '#36A2EB'], true, { scales: { y: { display: false } } });
            } else {
                document.getElementById('sexoCard').style.display = 'none';
            }
            
            // ... (Repita o padrão para estadoCivilChart, dispensaChart, etc.)
            
            // Gráfico de Ano de Nascimento (Linha)
            if (militaryStats.ano_nascimento) {
                // Configurações customizadas para o gráfico de linha
                const lineOptions = { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } };
                createChart('anoNascimentoChart', 'line', militaryStats.ano_nascimento.labels, militaryStats.ano_nascimento.data, ['#36A2EB'], false, lineOptions);
            }

            // Estatísticas Físicas (Tabela de Texto)
            if (militaryStats.estatisticas_fisicas) {
                document.getElementById('physicalStatsCard').style.display = 'block';
                const body = document.getElementById('physicalStatsBody');
                body.innerHTML = ''; // Limpa o "Carregando..."

                for (const [medida, dados] of Object.entries(militaryStats.estatisticas_fisicas)) {
                    const colDiv = document.createElement('div');
                    colDiv.className = 'col-12 mb-3';
                    
                    const content = `
                        <h6 class="text-capitalize">${medida}</h6>
                        <div class="small">
                            <div>Média: ${dados.media.toFixed(1)}</div>
                            <div>Mediana: ${dados.mediana.toFixed(1)}</div>
                            <div>Min: ${dados.min.toFixed(1)}</div>
                            <div>Max: ${dados.max.toFixed(1)}</div>
                        </div>
                    `;
                    colDiv.innerHTML = content;
                    body.appendChild(colDiv);
                }
            } else {
                document.getElementById('physicalStatsCard').style.display = 'none';
            }
            
        } else {
            militaryStatsSection.style.display = 'none'; // Esconde a seção se não houver dados militares
        }

    } catch (error) {
        console.error("Erro ao carregar os dados do dashboard:", error);
        // Exibir uma mensagem de erro amigável ao usuário, se necessário
    }
}

// Inicia o carregamento dos dados quando o script for executado
loadDashboardData();
</script>