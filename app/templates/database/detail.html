{% extends "base.html" %}

{% block title %}Detalhes do Upload - Sistema de Upload CSV{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h2 mb-4"><i class="bi bi-file-earmark-spreadsheet"></i> Detalhes do Upload</h1>
        <div>
            <a href="/database" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
            <button id="download-button" class="btn btn-success">
                <i class="bi bi-download"></i> Baixar Arquivo
            </button>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-info-circle"></i> Informações do Arquivo</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>Nome do arquivo:</strong></td>
                        <td id="file-name">Carregando...</td>
                    </tr>
                    <tr>
                        <td><strong>Data do upload:</strong></td>
                        <td id="upload-date">Carregando...</td>
                    </tr>
                    <tr>
                        <td><strong>Usuário:</strong></td>
                        <td id="user-name">Carregando...</td>
                    </tr>
                    <tr>
                        <td><strong>Tamanho:</strong></td>
                        <td id="file-size">Carregando...</td>
                    </tr>
                    <tr>
                        <td><strong>Total de linhas:</strong></td>
                        <td id="rows-total">Carregando...</td>
                    </tr>
                    <tr>
                        <td><strong>Total de colunas:</strong></td>
                        <td id="cols-total">Carregando...</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Colunas -->
<div class="row mt-4" id="columns-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header"><h5 class="card-title mb-0">Colunas e Tipos de Dados</h5></div>
            <div class="card-body" id="columns-container">
                <!-- Colunas virão aqui -->
            </div>
        </div>
    </div>
</div>

<!-- Preview -->
<div class="row mt-4" id="preview-section" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Preview dos Dados</h5>
            </div>
            <div class="card-body table-responsive">
                <table class="table table-striped table-hover table-sm">
                    <thead id="preview-header"></thead>
                    <tbody id="preview-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- JS para consumir a API -->
<script>
document.addEventListener("DOMContentLoaded", async () => {
    const uploadId = window.location.pathname.split("/").pop();
    const token = localStorage.getItem("access_token");

    if (!token) {
        alert("Usuário não autenticado.");
        window.location.href = "/login";
        return;
    }

    try {
        const res = await fetch(`/api/v1/manage-file/database/${uploadId}`, {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        if (!res.ok) {
            throw new Error("Erro ao buscar dados");
        }

        const data = await res.json();
        const upload = data.upload;

        document.getElementById("file-name").innerText = upload.original_name;
        document.getElementById("upload-date").innerText = new Date(upload.uploaded_at).toLocaleString("pt-BR");
        document.getElementById("user-name").innerText = upload.user.name + (upload.user.role === "operator" ? " (Operador)" : "");
        document.getElementById("file-size").innerText = formatSize(upload.size_bytes);
        document.getElementById("rows-total").innerText = upload.rows_total ?? "N/A";
        document.getElementById("cols-total").innerText = upload.cols_total ?? "N/A";

        // Colunas
        if (data.columns && data.columns.length > 0) {
            const container = document.getElementById("columns-container");
            container.innerHTML = "";
            data.columns.forEach(col => {
                const dtype = data.dtypes[col] || "string";
                const badgeClass = getDtypeBadgeClass(dtype);
                const el = `<div class="col-md-3 mb-2">
                                <div class="card border">
                                    <div class="card-body py-2">
                                        <h6 class="card-title mb-1">${col}</h6>
                                        <span class="badge bg-${badgeClass}">${dtype}</span>
                                    </div>
                                </div>
                            </div>`;
                container.innerHTML += el;
            });
            document.getElementById("columns-section").style.display = "block";
        }

        // Preview
        if (data.sample_rows && data.sample_rows.length > 0) {
            const header = document.getElementById("preview-header");
            const body = document.getElementById("preview-body");
            const columns = data.columns;

            // Cabeçalho
            header.innerHTML = "<tr>" + columns.map(c => `<th>${c}</th>`).join("") + "</tr>";

            // Corpo
            body.innerHTML = "";
            data.sample_rows.forEach(row => {
                const rowHtml = "<tr>" + columns.map(c => `<td>${row[c] ?? "-"}</td>`).join("") + "</tr>";
                body.innerHTML += rowHtml;
            });

            document.getElementById("preview-section").style.display = "block";
        }

    } catch (err) {
        console.error(err);
        alert("Erro ao carregar os dados.");
    }

    function formatSize(bytes) {
        const kb = bytes / 1024;
        const mb = kb / 1024;
        return mb >= 1 ? `${mb.toFixed(1)} MB` : `${kb.toFixed(1)} KB`;
    }

    function getDtypeBadgeClass(dtype) {
        switch (dtype) {
            case "int": return "primary";
            case "float": return "info";
            case "bool": return "success";
            case "datetime": return "warning";
            default: return "secondary";
        }
    }

    document.getElementById("download-button").addEventListener("click", async () => {
        const token = localStorage.getItem("access_token");

        if (!token) {
            alert("Usuário não autenticado.");
            return;
        }

        const uploadId = window.location.pathname.split("/").pop();

        try {
            const response = await fetch(`/api/v1/manage-file/database/${uploadId}/download`, {
                method: 'GET',
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });

            if (!response.ok) {
                throw new Error("Erro ao baixar o arquivo.");
            }

            const blob = await response.blob();
            const contentDisposition = response.headers.get("Content-Disposition");
            let filename = "arquivo.csv";

            // Tenta extrair o nome real do arquivo do header
            if (contentDisposition && contentDisposition.includes("filename=")) {
                const match = contentDisposition.match(/filename="?([^"]+)"?/);
                if (match) {
                    filename = match[1];
                }
            }

            // Cria link temporário para baixar
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

        } catch (err) {
            console.error(err);
            alert("Falha ao baixar o arquivo.");
        }
    });

});
</script>
{% endblock %}