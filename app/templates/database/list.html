{% extends "base.html" %}

{% block title %}Banco de Dados - Sistema de Upload CSV{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <h1 class="h2 mb-4">
      <i class="bi bi-database"></i> Banco de Dados
    </h1>
  </div>
</div>

<!-- Filtros -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="bi bi-funnel"></i> Filtros
        </h5>
      </div>
      <div class="card-body">
        <form id="filter-form">
          <div class="row g-3">
            <div class="col-md-3">
              <label for="q" class="form-label">Buscar por nome</label>
              <input type="text" class="form-control" id="q" name="q" placeholder="Nome do arquivo">
            </div>

            <div class="col-md-2">
              <label for="from_date" class="form-label">Data inicial</label>
              <input type="date" class="form-control" id="from_date" name="from_date">
            </div>

            <div class="col-md-2">
              <label for="to_date" class="form-label">Data final</label>
              <input type="date" class="form-control" id="to_date" name="to_date">
            </div>

            <div class="col-md-3">
              <label for="user_id" class="form-label">Usuário</label>
              <select class="form-select" id="user_id" name="user_id">
                <option value="">Todos os usuários</option>
              </select>
            </div>

            <div class="col-md-2">
              <label class="form-label">&nbsp;</label>
              <div class="d-grid">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-search"></i> Filtrar
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Tabela de Uploads -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="bi bi-table"></i> Uploads
        </h5>
        <span class="badge bg-secondary" id="total-count">0 registros</span>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover" id="uploadsTable">
            <thead>
              <tr>
                <th>Arquivo</th>
                <th>Tamanho</th>
                <th>Data Upload</th>
                <th>Usuário</th>
                <th>Linhas</th>
                <th>Colunas</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="uploads-body">
              <!-- Conteúdo será preenchido via JS -->
            </tbody>
          </table>
        </div>
        <!-- Paginação futura aqui -->
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const token = localStorage.getItem('access_token');
  if (!token) {
    alert("Você precisa estar logado.");
    window.location.href = "/login";
    return;
  }

  const uploadsTableBody = document.getElementById('uploads-body');
  const totalCountEl = document.getElementById('total-count');
  const userSelect = document.getElementById('user_id');
  const filterForm = document.getElementById('filter-form');

  // Carrega os uploads com os filtros atuais
  function fetchUploads(params = {}) {
    const query = new URLSearchParams(params).toString();
    fetch(`/api/v1/manage-file/database?${query}`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(res => {
      if (!res.ok) throw new Error("Erro ao buscar uploads.");
      return res.json();
    })
    .then(data => {
      uploadsTableBody.innerHTML = '';
      totalCountEl.textContent = `${data.pagination.total} registros`;

      data.uploads.forEach(upload => {
        const sizeMB = upload.size_bytes ? (upload.size_bytes / 1024 / 1024).toFixed(1) : '-';
        const sizeDisplay = upload.size_bytes < 1024 * 1024
          ? `${(upload.size_bytes / 1024).toFixed(1)} KB`
          : `${sizeMB} MB`;

        const userBadge = upload.user.role === 'operator'
          ? `<span class="badge bg-warning text-dark ms-1">Operador</span>`
          : '';

        const row = `
          <tr>
            <td><i class="bi bi-file-earmark-spreadsheet text-primary"></i> ${upload.original_name}</td>
            <td>${upload.size_bytes ? sizeDisplay : '-'}</td>
            <td>${new Date(upload.uploaded_at).toLocaleString('pt-BR')}</td>
            <td>${upload.user.name} ${userBadge}</td>
            <td>${upload.rows_total ?? '-'}</td>
            <td>${upload.cols_total ?? '-'}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <a href="/database/${upload.id}" class="btn btn-outline-primary" title="Ver detalhes">
                  <i class="bi bi-eye"></i>
                </a>
                <a href="/database/${upload.id}/download" class="btn btn-outline-success" title="Baixar">
                  <i class="bi bi-download"></i>
                </a>
              </div>
            </td>
          </tr>
        `;
        uploadsTableBody.insertAdjacentHTML('beforeend', row);
      });
    })
    .catch(error => {
      console.error(error);
      alert("Erro ao carregar os uploads.");
    });
  }

  // Preenche dropdown de usuários (opcional, se tiver endpoint)
  function fetchUsers() {
    fetch('/api/v1/user/users', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(res => res.json())
    .then(users => {
      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.name;
        userSelect.appendChild(option);
      });
    })
    .catch(() => {
      console.warn("Não foi possível carregar usuários (dropdown)");
    });
  }

  // Submete os filtros
  filterForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const params = {
      q: this.q.value,
      from_date: this.from_date.value,
      to_date: this.to_date.value,
      user_id: this.user_id.value
    };
    fetchUploads(params);
  });

  // Inicialização
  fetchUsers(); // se aplicável
  fetchUploads(); // primeira carga
});
</script>
{% endblock %}