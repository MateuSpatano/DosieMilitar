{% extends "base.html" %}

{% block title %}Perfil - Sistema de Upload CSV{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h2 mb-4">
            <i class="bi bi-person-gear"></i> Gerenciar Conta
        </h1>
    </div>
</div>

<div class="row">
    <!-- Informações do Perfil -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-person"></i> Informações do Perfil
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Nome:</strong></div>
                    <div class="col-sm-8" id="user-name">Carregando...</div>
                </div>

                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Email:</strong></div>
                    <div class="col-sm-8" id="user-email">Carregando...</div>
                </div>

                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Função:</strong></div>
                    <div class="col-sm-8" id="user-role">Carregando...</div>
                </div>

                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Membro desde:</strong></div>
                    <div class="col-sm-8" id="user-created">Carregando...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações da Conta -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i> Ações da Conta
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/account/change-password" class="btn btn-outline-primary">
                        <i class="bi bi-key"></i> Alterar Senha
                    </a>

                    <!-- Botão condicional -->
                    <a href="/account/delete" class="btn btn-outline-danger" id="delete-btn" style="display: none;">
                        <i class="bi bi-trash"></i> Excluir Conta
                    </a>

                    <button class="btn btn-outline-secondary" id="operator-delete-block" disabled style="display: none;">
                        <i class="bi bi-shield-exclamation"></i> Operador não pode excluir conta
                    </button>
                </div>

                <!-- Aviso condicional -->
                <div class="alert alert-warning mt-3" id="operator-warning" style="display: none;">
                    <i class="bi bi-info-circle"></i>
                    <strong>Conta de Operador:</strong> Esta conta possui privilégios administrativos e não pode ser excluída através da interface.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estatísticas do Usuário -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i> Suas Estatísticas
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <i class="bi bi-cloud-upload display-4 text-primary"></i>
                            <h4 class="mt-2" id="uploads-count">0</h4>
                            <p class="text-muted">Uploads Realizados</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <i class="bi bi-list-ul display-4 text-success"></i>
                            <h4 class="mt-2" id="lines-count">0</h4>
                            <p class="text-muted">Total de Linhas</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <i class="bi bi-hdd display-4 text-info"></i>
                            <h4 class="mt-2" id="space-used">0 MB</h4>
                            <p class="text-muted">Espaço Utilizado</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para carregar perfil via API -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const token = localStorage.getItem('access_token');

    if (!token) {
        alert("Você precisa estar logado.");
        window.location.href = "/login";  // ou a página de login do seu sistema
        return;
    }

    fetch('/api/v1/user/user-profile', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) throw new Error("Erro ao carregar perfil");
        return response.json();
    })
    .then(data => {
        document.getElementById('user-name').textContent = data.name;
        document.getElementById('user-email').textContent = data.email;
        document.getElementById('user-created').textContent = new Date(data.created_at).toLocaleDateString('pt-BR');

        // Função
        const userRole = data.role;
        const userRoleElement = document.getElementById('user-role');
        if (userRole === 'operator') {
            userRoleElement.innerHTML = '<span class="badge bg-warning text-dark"><i class="bi bi-shield-check"></i> Operador</span>';
            document.getElementById('delete-btn').style.display = 'none';
            document.getElementById('operator-delete-block').style.display = 'inline-block';
            document.getElementById('operator-warning').style.display = 'block';
        } else {
            userRoleElement.innerHTML = '<span class="badge bg-secondary"><i class="bi bi-person"></i> Usuário</span>';
            document.getElementById('delete-btn').style.display = 'inline-block';
        }

        // Estatísticas
        document.getElementById('uploads-count').textContent = data.stats.uploads;
        document.getElementById('lines-count').textContent = data.stats.lines;
        document.getElementById('space-used').textContent = `${data.stats.space_used_mb} MB`;
    })
    .catch(error => {
        console.error('Erro:', error);
        alert("Erro ao carregar os dados do perfil.");
    });
});
</script>

{% endblock %}